/**
 * JavaScript for managing unassigned Teams attendance records
 * @module     mod_zoomattendance/unassigned_manager
 * @package    mod_zoomattendance
 * @copyright  2025 Invisiblefarm srl
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","core/ajax","core/notification","core/str"],function(e,t,s,a){"use strict";var i=function(e){this.currentPage=0,this.currentFilter=this.getFilterFromURL(),this.currentPageSize=50,this.selectedRecords=new Set,this.isLoading=!1,this.cmId=e.cmId,this.sesskey=e.sesskey||M.cfg.sesskey,this.strings=e.strings||{},this.availableUsers=e.available_users||[],console.log("MANAGER INIT: constructor called with config:",e),console.log("MANAGER INIT: initial available users count:",this.availableUsers.length),window.unassignedManager=this,this.init(),this.loadAvailableUsers()};return i.prototype={getFilterFromURL:function(){return new URLSearchParams(window.location.search).get("filter")||"all"},updateURL:function(e){var t=new URL(window.location);e&&"all"!==e?t.searchParams.set("filter",e):t.searchParams.delete("filter"),window.history.replaceState({},"",t)},updateStatistics:function(){e.ajax({url:window.location.href,data:{ajax:1,action:"get_statistics"},success:function(t){if(t.success){var s=t.data;e("#name-suggestions-count").text(s.name_suggestions),e("#email-suggestions-count").text(s.email_suggestions);var a=s.total_unassigned-s.name_suggestions-s.email_suggestions;e("#no-suggestions-count").text(a)}}})},init:function(){this.syncSelectValues(),this.bindEvents(),this.loadPage(0),this.updateStatistics()},syncSelectValues:function(){e("#filter-select").val(this.currentFilter),e("#page-size-select").val(this.currentPageSize)},getCurrentFilters:function(){var e={};if("all"!==this.currentFilter)switch(this.currentFilter){case"name_suggestions":e.suggestion_type="name_based";break;case"email_suggestions":e.suggestion_type="email_based";break;case"without_suggestions":e.suggestion_type="none"}return e},applyCurrentSettings:function(){var t=e("#filter-select").val(),s=e("#page-size-select").val(),a=t!==this.currentFilter,i="all"===s?999999:parseInt(s),n=i!==this.currentPageSize;(a||n)&&sessionStorage.clear(),this.currentFilter=t,this.updateURL(this.currentFilter),this.currentPageSize=i,this.currentPage=0,this.selectedRecords.clear(),this.updateBulkButton(),this.loadPage(0,!0),this.updateStatistics()},bindEvents:function(){var t=this;e("#filter-select, #page-size-select").on("change",function(e){t.applyCurrentSettings()}),e("#bulk-assign-btn").on("click",function(){t.selectedRecords.size>0&&t.performBulkAssignment()})},loadAvailableUsers:function(){var t=this;e.ajax({url:window.location.href,data:{ajax:1,action:"get_available_users"},success:function(e){e.success&&(t.availableUsers=e.users)}})},loadPage:function(t,s){if(!this.isLoading){var a=this;this.isLoading=!0,e("#loading-indicator").show();var i=this.getCurrentFilters(),n=999999===this.currentPageSize?"all":this.currentPageSize,r="page_"+t+"_"+JSON.stringify(i)+"_"+n;if(!s&&sessionStorage.getItem(r)){var o=JSON.parse(sessionStorage.getItem(r));return this.renderPage(o),this.isLoading=!1,void e("#loading-indicator").hide()}e.ajax({url:window.location.href,method:"GET",data:{ajax:1,action:"load_page",page:t,per_page:n,filters:JSON.stringify(i),sesskey:this.sesskey},success:function(e){e.success?(sessionStorage.setItem(r,JSON.stringify(e.data)),a.renderPage(e.data)):a.showError("Failed to load data: "+(e.error||"Unknown error"))},error:function(e,t,s){a.showError("Connection error: "+s)},complete:function(){a.isLoading=!1,e("#loading-indicator").hide()}})}},renderPage:function(e){this.currentPage=e.pagination.page,this.renderTable(e.records),this.renderPagination(e.pagination),this.updateBulkButton(),this.bindTableEvents()},renderTable:function(t){var s='<div class="table-responsive">';if(s+='<table class="table table-striped table-hover">',s+='<thead class="thead-dark">',s+="<tr>",s+="<th>"+(this.strings.zoom_participant_name||"Partecipante Zoom")+"</th>",s+="<th>"+(this.strings.attendance_duration||"Durata Presenza")+"</th>",s+='<th><input type="checkbox" id="select-all"></th>',s+="<th>"+(this.strings.suggested_match||"Corrispondenza Suggerita")+"</th>",s+="<th>"+(this.strings.actions||"Azioni")+"</th>",s+="</tr>",s+="</thead>",s+="<tbody>",0===t.length)s+='<tr><td colspan="5" class="text-center text-muted">',s+=this.strings.no_records_found||"Nessun record trovato",s+="</td></tr>";else for(var a=0;a<t.length;a++)s+=this.renderTableRow(t[a]);s+="</tbody></table></div>",e("#records-container").html(s)},renderTableRow:function(e){var t="suggestion-none-row";e.has_suggestion&&e.suggestion&&("name_based"===e.suggestion_type?t="suggestion-name-row":"email_based"===e.suggestion_type&&(t="suggestion-email-row"));var s='<tr data-record-id="'+e.id+'" class="'+t+'">';s+="<td>"+this.escapeHtml(e.name)+"</td>",s+="<td>"+this.formatDuration(e.attendance_duration)+"</td>",s+="<td>";var a=e.has_suggestion&&e.suggestion?' checked="checked"':"";if(s+='<input type="checkbox" class="record-checkbox" value="'+e.id+'"'+a+">",s+="</td>",s+="<td>",e.has_suggestion&&e.suggestion){var i=e.suggestion.user,n=e.suggestion.confidence,r=e.suggestion_type;s+='<span class="badge badge-'+("high"===n?"success":"warning")+'">',s+=this.escapeHtml(i.firstname+" "+i.lastname),s+="</span>",s+='<br><small class="text-muted">'+r+" match</small>"}else s+='<span class="text-muted">'+(this.strings.no_suggestion||"Nessun suggerimento")+"</span>";return s+="</td>",s+="<td>",s+='<div class="action-column d-flex flex-column gap-2">',e.has_suggestion&&e.suggestion?(s+='<button class="btn btn-sm btn-success apply-suggestion-btn" ',s+='data-record-id="'+e.id+'" ',s+='data-user-id="'+e.suggestion.user.id+'">',s+=this.strings.apply_suggestion||"Applica suggerimento",s+="</button>"):(s+='<button class="btn btn-sm btn-secondary apply-suggestion-btn" disabled>',s+=this.strings.no_suggestion||"Nessun suggerimento",s+="</button>"),s+='<div class="searchable-select-container" data-record-id="'+e.id+'" style="position: relative;">',s+='<input type="text" class="form-control form-control-sm user-search-input" ',s+='placeholder="Cerca utente..." style="margin-bottom: 2px;">',s+='<div class="search-results-dropdown" style="display: none; max-height: 150px; overflow-y: auto; border: 1px solid #ccc; background: white; position: absolute; z-index: 1000; width: 100%;"></div>',s+='<button class="btn btn-sm btn-primary manual-assign-btn" ',s+='data-record-id="'+e.id+'" disabled>',s+=this.strings.assign||"Assegna",s+="</button>",s+="</div>",s+="</div>",s+="</td>",s+="</tr>"},initSearchableDropdown:function(t){var s=this,a=t.data("record-id"),i=t.find(".user-search-input"),n=t.find(".search-results-dropdown"),r=t.find(".manual-assign-btn"),o=null;i.on("focus",function(){s.updateSearchResults(n,"",r),n.show()}),i.on("blur",function(){setTimeout(function(){n.hide()},200)}),i.on("input",function(){var t=e(this).val();s.updateSearchResults(n,t,r),o=null,r.prop("disabled",!0)}),n.on("click",".user-option",function(){var t=e(this).data("user-id"),s=e(this).text();o=t,i.val(s),n.hide(),r.prop("disabled",!1)}),r.on("click",function(){o&&s.applySingleSuggestion(a,o,e(this))})},updateSearchResults:function(t,s,a){var i=this,n=this.availableUsers;if(s.trim()){var r=s.toLowerCase();n=this.availableUsers.filter(function(e){return-1!==e.name.toLowerCase().indexOf(r)})}var o="";0===n.length?o='<div class="user-option text-muted p-2">Nessun utente trovato</div>':n.forEach(function(e){o+='<div class="user-option p-2" data-user-id="'+e.id+'" ',o+='style="cursor: pointer; border-bottom: 1px solid #eee;">',o+=i.escapeHtml(e.name),o+="</div>"}),t.html(o),t.find(".user-option").on("mouseenter",function(){e(this).css("background-color","#f8f9fa")}).on("mouseleave",function(){e(this).css("background-color","white")}),t.show()},renderPagination:function(t){var s=this;if(0!==t.total_count){var a='<nav aria-label="Pagination">';if(!t.show_all&&t.total_pages>1){a+='<ul class="pagination justify-content-center">',a+='<li class="page-item '+(t.has_previous?"":"disabled")+'">',a+='<a class="page-link" href="#" data-page="'+(t.page-1)+'">',a+=this.strings.previous||"Precedente",a+="</a></li>";for(var i=Math.max(0,t.page-2),n=Math.min(t.total_pages-1,t.page+2),r=i;r<=n;r++)a+='<li class="page-item '+(r===t.page?"active":"")+'">',a+='<a class="page-link" href="#" data-page="'+r+'">'+(r+1)+"</a>",a+="</li>";a+='<li class="page-item '+(t.has_next?"":"disabled")+'">',a+='<a class="page-link" href="#" data-page="'+(t.page+1)+'">',a+=this.strings.next||"Successivo",a+="</a></li>",a+="</ul>"}a+='<div class="text-center mt-2">',t.show_all||999999===this.currentPageSize?a+="<strong>"+t.total_count+" record trovati (tutti visualizzati)</strong>":t.total_pages>1?(a+="Pagina "+(t.page+1)+" di "+t.total_pages+" - ",a+=t.total_count+" record totali"):a+=t.total_count+" record trovati",a+="</div>",a+="</nav>",e("#pagination-container").html(a),!t.show_all&&t.total_pages>1&&e(".page-link").on("click",function(a){a.preventDefault();var i=parseInt(e(this).data("page"));i>=0&&i<t.total_pages&&s.loadPage(i)})}else e("#pagination-container").html('<div class="text-center mt-2 text-muted">Nessun record trovato per il filtro selezionato</div>')},bindTableEvents:function(){var t=this;e(".record-checkbox:checked").each(function(){t.selectedRecords.add(parseInt(e(this).val()))}),t.updateBulkButton();var s=e(".record-checkbox").length,a=e(".record-checkbox:checked").length;s>0&&s===a&&e("#select-all").prop("checked",!0),e("#select-all").on("change",function(s){var a=e(this).prop("checked");e(".record-checkbox").prop("checked",a),a?e(".record-checkbox").each(function(){t.selectedRecords.add(parseInt(e(this).val()))}):t.selectedRecords.clear(),t.updateBulkButton()}),e(".record-checkbox").on("change",function(s){var a=parseInt(e(this).val());e(this).prop("checked")?t.selectedRecords.add(a):t.selectedRecords.delete(a),t.updateBulkButton();var i=e(".record-checkbox").length,n=e(".record-checkbox:checked").length;e("#select-all").prop("checked",i===n)}),e(".apply-suggestion-btn").on("click",function(s){var a=e(this).data("record-id"),i=e(this).data("user-id");i&&t.applySingleSuggestion(a,i,e(this))}),e(".searchable-select-container").each(function(){t.initSearchableDropdown(e(this))})},updateBulkButton:function(){var t=this.selectedRecords.size;e("#bulk-assign-btn").prop("disabled",0===t),e("#bulk-assign-btn").text((this.strings.apply_selected||"Applica selezionati")+" ("+t+")")},applySingleSuggestion:function(t,s,a){var i=this;a.prop("disabled",!0).text((this.strings.applying||"Applicando")+"..."),e.ajax({url:window.location.href,method:"POST",data:{ajax:1,action:"assign_user",recordid:t,userid:s,sesskey:this.sesskey},success:function(s){s.success?(e('tr[data-record-id="'+t+'"]').fadeOut(),i.selectedRecords.delete(t),i.updateBulkButton(),sessionStorage.clear(),i.updateStatistics(),i.showSuccess(s.message)):(i.showError(s.error),a.prop("disabled",!1).text(i.strings.apply_suggestion||"Applica suggerimento"))},error:function(){i.showError("Connection error"),a.prop("disabled",!1).text(i.strings.apply_suggestion||"Applica suggerimento")}})},performBulkAssignment:function(){if(0!==this.selectedRecords.size){var t=this;e("#progress-container").show(),e("#bulk-assign-btn").prop("disabled",!0);var s={};this.selectedRecords.forEach(function(t){var a=e('tr[data-record-id="'+t+'"]').find(".apply-suggestion-btn");a.length&&!a.prop("disabled")&&(s[t]=a.data("user-id"))}),e.ajax({url:window.location.href,method:"POST",data:{ajax:1,action:"bulk_assign",assignments:s,sesskey:this.sesskey},success:function(s){if(s.success){var a=s.data;e("#progress-bar").css("width","100%").addClass("bg-success"),e("#progress-text").text("Complete: "+a.successful+"/"+a.total+" successful"),t.selectedRecords.clear(),sessionStorage.clear(),t.updateStatistics(),setTimeout(function(){e("#progress-container").hide(),t.loadPage(t.currentPage,!0)},2e3),t.showSuccess("Bulk assignment completed: "+a.successful+" successful, "+a.failed+" failed")}else t.showError(s.error)},error:function(){t.showError("Connection error during bulk assignment")},complete:function(){e("#bulk-assign-btn").prop("disabled",!1)}})}},formatDuration:function(e){return Math.floor(e/3600)+"h "+Math.floor(e%3600/60)+"m"},escapeHtml:function(e){var t=document.createElement("div");return t.textContent=e,t.innerHTML},showSuccess:function(e){this.showToast(e,"success",5e3)},showError:function(e){this.showToast(e,"danger",8e3)},showToast:function(t,s,a){var i=e('<div class="alert alert-'+s+' alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 9999;"><button type="button" class="close" data-dismiss="alert">&times;</button>'+t+"</div>");e("body").append(i),setTimeout(function(){i.remove()},a)}},{init:function(e){return new i(e)}}});